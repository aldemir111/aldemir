<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Trivia Anticonceptivos</title>
    <style>
        /* Estilos generales y existentes */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            width: 95%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            padding: 40px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 3.2em;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
            background: linear-gradient(45deg, #ffd700, #ff69b4, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        h2 {
            font-size: 2.5em;
            margin-bottom: 25px;
            color: #ffd700;
             text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }

        .subtitle {
            font-size: 1.3em;
            margin-bottom: 30px;
            opacity: 0.9;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            padding: 18px 35px;
            margin: 12px;
            border-radius: 30px;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        }

        .btn:active {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #a8e6cf, #dcedc8);
            color: #2c3e50;
        }

        .input-group {
            margin: 25px 0;
        }

        .input-group input, .input-group select {
            padding: 15px 25px;
            border: none;
            border-radius: 20px;
            font-size: 1.1em;
            margin: 8px;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            min-width: 250px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .question-container {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 30px;
            margin: 25px 0;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .question-number {
            font-size: 1.3em;
            color: #ffd700;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .question {
            font-size: 1.4em;
            margin-bottom: 30px;
            line-height: 1.5;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
            margin: 25px 0;
        }

        .option {
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid transparent;
            padding: 18px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.4s ease;
            font-size: 1.1em;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        .option.disabled {
            pointer-events: none;
            opacity: 0.7;
        }

        .option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.3s;
        }

        .option:hover::before {
            left: 100%;
        }

        .option:not(.disabled):hover {
            background: rgba(255, 255, 255, 0.35);
            border-color: #ffd700;
            transform: scale(1.03);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .option.selected {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-color: #ffd700;
            transform: scale(1.05);
        }

        .option.correct {
            background: linear-gradient(45deg, #4CAF50, #8BC34A) !important;
            border-color: #4CAF50 !important;
            animation: correctPulse 0.6s ease-in-out;
        }

        .option.incorrect {
            background: linear-gradient(45deg, #f44336, #ff5722) !important;
            border-color: #f44336 !important;
            animation: incorrectShake 0.6s ease-in-out;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1.05); }
            50% { transform: scale(1.1); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .timer { 
            font-size: 3.8em; 
            color: #ffd700;
            margin: 20px 0 25px 0; 
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
            font-weight: bold;
        }

        .timer.urgent {
            color: #ff4444;
            animation: timerPulse 1s infinite;
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .score-display { 
            font-size: 1.6em;
            margin: 25px 0;
            color: #4ecdc4;
            font-weight: bold;
        }

        .player-info {
            display: flex;
            justify-content: space-around;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 20px;
            margin: 25px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .player {
            text-align: center;
            padding: 15px;
            border-radius: 15px;
            transition: all 0.4s ease;
            flex: 1;
            margin: 0 10px;
        }

        .player.active-turn { 
            background: linear-gradient(45deg, #ffd700, #ff69b4);
            transform: scale(1.08);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4);
            animation: playerGlow 2s ease-in-out infinite;
        }

        @keyframes playerGlow {
            0%, 100% { box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4); }
            50% { box-shadow: 0 15px 35px rgba(255, 215, 0, 0.6); }
        }

        .player-name {
            font-weight: bold;
            font-size: 1.3em;
            color: #ffd700;
            margin-bottom: 8px;
        }

        .player.active-turn .player-name {
            color: #fff;
        }

        .player-score {
            font-size: 1.2em;
            color: #4ecdc4;
        }

        .player.active-turn .player-score {
            color: #fff;
        }

        .current-turn-indicator { 
            font-size: 1.4em;
            color: #ffd700;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .phrase-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
        }

        .phrase-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .phrase-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px; /* Ajustado */
            border-radius: 25px;
            text-align: center;
            max-width: 90%; /* Ajustado */
            max-height: 85%; /* Ajustado */
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 3px solid rgba(255, 255, 255, 0.3);
            animation: phraseAnimation 0.6s ease-out;
        }

        @keyframes phraseAnimation {
            0% {
                transform: scale(0.3) rotate(-15deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.1) rotate(3deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .phrase-text {
            font-size: 2.6em; /* AUMENTADO */
            font-weight: bold;
            color: white;
            margin-bottom: 15px; /* Reducido */
            text-shadow: 
                -1px -1px 0 #000,  
                 1px -1px 0 #000,
                -1px  1px 0 #000,
                 1px  1px 0 #000,
                 2px 2px 5px rgba(0,0,0,0.7); /* CONTORNO */
            line-height: 1.3;
        }

        .phrase-player {
            font-size: 1.8em; /* AUMENTADO */
            color: #ffd700;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 15px; /* Reducido */
        }

        /* NUEVO: Estilo para resaltar vidas restantes en el overlay */
        .lives-remaining-highlight {
            font-weight: bold;
            color: #FFD700; /* Dorado brillante */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        /* NUEVO: Contenedor para corazones en el overlay de frase */
        .phrase-lives-hearts {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
            margin-bottom: 20px; /* Espacio antes del bot√≥n */
            gap: 8px;
        }

        /* NUEVO: Estilo para corazones individuales en el overlay de frase */
        .life-heart-overlay {
            font-size: 2.2em; /* Tama√±o de los corazones en el overlay */
            transition: color 0.3s ease, transform 0.3s ease;
        }


        .phrase-close {
            margin-top: 20px; /* Ajustado */
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            padding: 18px 35px;
            border-radius: 30px;
            color: white;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .phrase-close:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4ecdc4, #44d7c4);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .credits {
            font-size: 0.95em;
            opacity: 0.8;
            margin-bottom: 25px;
            font-style: italic;
        }

        .results-screen-content { 
            text-align: center;
            padding: 30px;
        }

        .final-score {
            font-size: 2.5em;
            color: #ffd700;
            margin: 30px 0;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
        }

        .winner-announcement {
            font-size: 2em;
            color: #4ecdc4;
            margin: 20px 0;
            font-weight: bold;
        }

        .lives-container {
            display: flex;
            justify-content: center;
            align-items: center; 
            margin-top: 10px;
            gap: 5px; 
        }
        
        .lives-text {
            font-size: 1.5em; 
            margin-right: 10px; 
            font-weight: bold;
        }

        .life-hearts {
            display: flex;
        }
        
        .life {
            width: auto; 
            height: auto; 
            margin: 0 4px; 
            display: flex;
            justify-content: center;
            align-items: center;
            color: #ff6b6b; 
            font-weight: bold;
            font-size: 2.2em; 
            transition: color 0.3s ease, transform 0.3s ease;
        }
        
        .life.lost {
            color: #555;
            transform: scale(0.8);
        }
        
        .turn-selector-overlay, .tie-breaker-overlay-style { /* Applied to both */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.92); 
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .turn-selector-overlay.show, .tie-breaker-overlay-style.show { /* Applied to both */
            opacity: 1;
            visibility: visible;
        }

        .turn-selector-content, .tie-breaker-content-style { /* Applied to both */
            background: linear-gradient(135deg, #6a82fb 0%, #fc5c7d 100%); 
            padding: 50px; 
            border-radius: 30px;
            text-align: center;
            max-width: 90%; 
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            border: 3px solid rgba(255, 255, 255, 0.4);
            animation: phraseAnimation 0.6s ease-out; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .turn-selector-title, .tie-breaker-title-style { /* Applied to both */
            font-size: 2.8em; 
            margin-bottom: 30px; 
            color: #ffffff;
            font-weight: bold;
            text-shadow: 3px 3px 7px rgba(0, 0, 0, 0.6);
        }
        
        .turn-selector-instruction-text, .tie-breaker-instruction-text-style { /* Applied to both */
             font-size: 1.3em;
             margin-bottom: 25px;
             color: rgba(255,255,255,0.9);
        }
        .tie-breaker-specific-instruction { /* Specific for tie-breaker */
            font-weight: bold;
            color: #ffd700;
            font-size: 1.4em;
            margin-bottom: 20px;
        }


        .countdown-timer { 
            font-size: 6em; 
            font-weight: bold;
            color: #ffd700; 
            margin-bottom: 35px; 
            text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.5);
            line-height: 1;
        }

        .countdown-timer.urgent { 
            color: #ff4444;
            animation: timerPulse 0.5s infinite alternate; 
        }

        .player-instructions {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 700px; 
            margin-top: 30px; 
            gap: 25px; 
        }

        .player-instruction-item { 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; 
            flex: 1;
            min-height: 200px; 
            font-size: 1.2em;
            padding: 25px;
            border-radius: 20px;
            border: 3px solid transparent; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .player-instruction-item:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 12px 25px rgba(0,0,0,0.4);
        }


        .player-instruction-item.p1 {
            background: linear-gradient(135deg, #ff7e5f, #feb47b); 
            border-color: #ff7e5f;
        }

        .player-instruction-item.p2 {
            background: linear-gradient(135deg, #00c6ff, #0072ff); 
            border-color: #00c6ff;
        }

        .player-instruction-item .player-name-key {
            font-size: 1.9em; 
            font-weight: bold;
            margin-bottom: 20px; 
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
        }

        .player-instruction-item .key-display {
            font-size: 2.8em; 
            font-weight: bold;
            background-color: rgba(0, 0, 0, 0.4); 
            color: #fff;
            padding: 18px 35px; 
            border-radius: 18px; 
            margin-top: 15px; 
            display: inline-block;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255,255,255,0.5);
        }

        /* Media Queries para responsividad */
        @media (max-width: 768px) {
            .container { padding: 25px; width: 98%; }
            h1 { font-size: 2.2em; }
            h2 { font-size: 2em; }
            .options { grid-template-columns: 1fr; gap: 12px; }
            .player-info { flex-direction: column; gap: 15px; }
            .phrase-content { padding: 30px 20px; max-width: 95%; }
            .phrase-text { font-size: 1.8em; } /* Ajustado para m√≥viles */
            .phrase-player { font-size: 1.5em; }
            .life-heart-overlay { font-size: 1.8em; } 
            .input-group input, .input-group select { min-width: 200px; font-size: 1em; }
            .player-instructions { flex-direction: column; max-width: 90%; }
            .player-instruction-item { max-width: 100%; min-height: auto; padding: 20px; }
            .turn-selector-content, .tie-breaker-content-style { padding: 30px 20px; }
            .turn-selector-title, .tie-breaker-title-style { font-size: 2em; }
            .countdown-timer { font-size: 4.5em; }
            .player-instruction-item .player-name-key { font-size: 1.5em; }
            .player-instruction-item .key-display { font-size: 2.2em; padding: 15px 25px; }
            .lives-container { flex-direction: column; align-items: center; }
            .timer { font-size: 3em; } 
            .lives-text { font-size: 1.3em; }
            .life { font-size: 1.8em; }
        }

        @media (max-width: 480px) {
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.7em; }
            .phrase-text { font-size: 1.5em; } /* Ajustado para m√≥viles peque√±os */
            .phrase-player { font-size: 1.3em; }
            .life-heart-overlay { font-size: 1.6em; }
            .btn { padding: 12px 25px; font-size: 1em; }
            .turn-selector-content, .tie-breaker-content-style { padding: 20px 15px; }
            .turn-selector-title, .tie-breaker-title-style { font-size: 1.7em; }
            .countdown-timer { font-size: 3.5em; }
            .player-instruction-item .player-name-key { font-size: 1.2em; }
            .player-instruction-item .key-display { font-size: 1.8em; padding: 12px 20px; }
            .timer { font-size: 2.5em; } 
            .lives-text { font-size: 1.1em; }
            .life { font-size: 1.5em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="screen active" id="menuScreen">
            <h1>üéØ Trivia Anticonceptivos</h1>
            <p class="subtitle">¬°Pon a prueba tus conocimientos sobre salud reproductiva! üíä</p>
            <div class="credits">
                Creado con ‚ù§Ô∏è por <strong>Aldemir</strong> ‚ú®
            </div>
            <button class="btn" onclick="showSetup('individual')">üéÆ Juego Individual</button>
            <button class="btn" onclick="showSetup('versus')">‚öîÔ∏è Modo Versus</button>
        </div>

        <div class="screen" id="setupScreen">
            <h2>‚öôÔ∏è Configuraci√≥n del Juego</h2>
            <div class="input-group">
                <input type="text" id="player1NameInput" placeholder="Nombre del Jugador 1" required maxlength="15">
                <div id="versusInputsContainer" style="display: none;">
                    <input type="text" id="player2NameInput" placeholder="Nombre del Jugador 2" required maxlength="15">
                    <select id="questionCountSelect">
                        <option value="5">5 preguntas</option>
                        <option value="10">10 preguntas</option>
                        <option value="20">20 preguntas</option>
                        <option value="all" selected>Todas (~58)</option>
                    </select>
                </div>
            </div>
            <button class="btn" onclick="initiateGame()">üöÄ Comenzar Juego</button>
            <button class="btn btn-secondary" onclick="resetGameAndShowMenu()">‚Ü©Ô∏è Volver al Men√∫</button>
        </div>

        <div class="screen" id="gameScreen">
            <div class="player-info" id="playerInfoPanel"></div>
            <div class="current-turn-indicator" id="currentTurnIndicator"></div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            
            <div class="timer" id="questionTimerDisplay">‚è∞ 40</div>
            <div class="score-display" id="questionProgressDisplay">Pregunta 1 de N</div>
            
            <div class="question-container">
                <div class="question-number" id="questionNumberDisplay">Pregunta 1</div>
                <div class="question" id="questionTextDisplay"></div>
                <div class="options" id="optionsContainer"></div>
            </div>
            
            <div style="margin-top: 25px;">
                <button class="btn" id="nextQuestionBtn" onclick="proceedToNextStep()" style="display: none;">‚û°Ô∏è Siguiente</button>
                <button class="btn btn-secondary" onclick="resetGameAndShowMenu()">üè† Volver al Men√∫</button>
            </div>
        </div>

        <div class="screen" id="resultsScreen">
            <div class="results-screen-content">
                <h2>üèÜ ¬°Juego Terminado!</h2>
                <div class="winner-announcement" id="winnerText"></div>
                <div class="final-score" id="finalScoresText"></div>
                <button class="btn" onclick="resetGameAndShowMenu()">üîÑ Jugar de Nuevo</button>
            </div>
        </div>

        <div class="phrase-overlay" id="phraseOverlay">
            <div class="phrase-content">
                <div class="phrase-text" id="phraseText"></div>
                <div class="phrase-player" id="phrasePlayerName"></div>
                <div class="phrase-lives-hearts" id="phraseLivesHeartsContainer"></div>
                <button class="phrase-close" id="phraseCloseBtn" onclick="closePhraseOverlay()">‚ú® Continuar</button>
            </div>
        </div>

        <div class="turn-selector-overlay" id="turnSelectorOverlay">
            <div class="turn-selector-content">
                <div class="turn-selector-title" id="turnSelectorTitle">¬øQui√©n presiona primero?</div>
                <div class="countdown-timer" id="turnSelectionCountdownDisplay">4</div>
                <p class="turn-selector-instruction-text" id="turnSelectorInstructionText">¬°El primero en presionar su tecla gana el turno!</p>
                <div class="player-instructions">
                    <div class="player-instruction-item p1">
                        <div class="player-name-key">Jugador 1: <span id="player1NameKeyRace"></span></div>
                        <div class="key-display">ESPACIO</div>
                    </div>
                    <div class="player-instruction-item p2">
                        <div class="player-name-key">Jugador 2: <span id="player2NameKeyRace"></span></div>
                        <div class="key-display">ENTER</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tie-breaker-overlay-style" id="tieBreakerOverlay">
            <div class="tie-breaker-content-style">
                <div class="tie-breaker-title-style" id="tieBreakerTitle">¬°DESEMPATE FINAL!</div>
                <p class="tie-breaker-instruction-text-style">Una √∫ltima pregunta para decidir al ganador.</p>
                <p class="tie-breaker-specific-instruction">Quien presione primero responde. Si acierta, GANA. Si falla, PIERDE.</p>
                <div class="countdown-timer" id="tieBreakerCountdownDisplay">4</div>
                <p class="tie-breaker-instruction-text-style" id="tieBreakerTurnSelectorInstructionText">¬°El primero en presionar su tecla gana el turno para el desempate!</p>
                <div class="player-instructions">
                    <div class="player-instruction-item p1">
                        <div class="player-name-key">Jugador 1: <span id="player1NameKeyRaceTiebreaker"></span></div>
                        <div class="key-display">ESPACIO</div>
                    </div>
                    <div class="player-instruction-item p2">
                        <div class="player-name-key">Jugador 2: <span id="player2NameKeyRaceTiebreaker"></span></div>
                        <div class="key-display">ENTER</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Configuraci√≥n del juego
        const GAME_CONFIG = {
            DEFAULT_TIME: 40,
            MIN_TIME: 10, 
            TIME_REDUCTION_ON_CORRECT: 3, 
            CONFETTI_COUNT: 60,
            MAX_LIVES: 3,
            TURN_SELECT_COUNTDOWN: 4,
            KEY_RACE_TIME: 3 
        };

        const frasesPerdedor = ["¬°JAJAJA! ¬øEso fue un intento? üòÇ", "¬°Hasta mi abuela sabe m√°s que t√∫! üëµ", "¬øSeguro que no est√°s jugando con los ojos cerrados? üßë‚Äçü¶Ø", "¬°Esa respuesta fue m√°s floja que chicle pegado en el zapato! üëü", "¬°Con esos conocimientos mejor ded√≠cate a otra cosa! üöÆ", "¬°Verg√ºenza deber√≠a darte! ü´£", "¬øEn serio? ¬øEsa fue tu mejor respuesta? ü§¶", "¬°Ni con las respuestas escritas en la mano! ‚úã", "¬°Pat√©tico! Hasta un ni√±o de kinder lo har√≠a mejor üßí", "¬°Esa respuesta me dio pena ajena! üò≥"];
        const frasesGanador = ["¬°Eres un genio! ¬øD√≥nde te escond√≠as? üß†", "¬°Impresionante! Deber√≠as dar clases üìö", "¬°WOW! Tu conocimiento es asombroso ‚ú®", "¬°Perfecto! Eres el/la mejor sin duda üèÜ", "¬°Insuperable! Nadie puede contra ti üí™", "¬°Brillante! Como un diamante üíé", "¬°Excelente! Deber√≠as estar orgulloso/a üòä", "¬°Incre√≠ble! Eres una m√°quina de conocimiento ü§ñ", "¬°Perfect score! ¬øEres humano o robot? ü§ñ", "¬°Legendario/a! Tu nombre quedar√° en los records üèÖ"];
        
        const burlasBrutales = [
            "¬øEn serio eres estudiante de Medicina? Hasta un libro de texto cerrado tiene m√°s sentido com√∫n que t√∫.",
            "Con esa respuesta, hasta el placebo tendr√≠a mejor efecto que tu conocimiento.",
            "Si esto fuera un parto, ya hubieras matado a la madre y al beb√©‚Ä¶ y ni siquiera eras el cirujano.",
            "¬øSeguro no confundiste la facultad con la cafeter√≠a? Porque lo √∫nico que procesas es caf√©, no informaci√≥n.",
            "Hasta un muerto en Anatom√≠a da mejores respuestas‚Ä¶ y ellos ni siquiera tienen cerebro.",
            "Si los anticonceptivos fallaran tanto como t√∫, la humanidad ya se habr√≠a extinguido.",
            "Ni con ChatGPT sacar√≠as una respuesta tan mala‚Ä¶ y eso que a veces inventa cosas.",
            "¬øEstudias Medicina o Adivinaci√≥n? Porque esa respuesta no tiene base cient√≠fica, solo suerte mala.",
            "Si el examen fuera salvar una vida, ya estar√≠as firmando el certificado de defunci√≥n.",
            "Hasta un meme de Facebook tiene m√°s rigor m√©dico que t√∫.",
            "Si los anticonceptivos fueran tan ineficaces como t√∫, ya estar√≠amos en un apocalipsis demogr√°fico.",
            "Con ese nivel, mejor ded√≠cate a vender seguros‚Ä¶ o a ser conejillo de indias en Farmacolog√≠a.",
            "¬øSeguro no eres de Derecho? Porque esa respuesta es un crimen contra la ciencia.",
            "Si la Medicina fuera un videojuego, ya te habr√≠an dado ‚ÄòGame Over‚Äô.",
            "Hasta un virus tiene mejor capacidad de procesamiento que t√∫.",
            "Seguro pasas con puro test... y de los f√°ciles."
        ];

        const elogiosSarcasmoBrutal = [
            "¬°Correcto! Aunque hasta un ni√±o de primaria con Google lo sabr√≠a, pero bueno, felicidades.",
            "Wow, acertaste. ¬øQuieres una medalla‚Ä¶ o prefieres que te explique otra vez por si acaso?",
            "¬°Bien! Ahora demu√©stralo en la pr√°ctica‚Ä¶ si es que pasas de te√≥rico a real alguna vez.",
            "Aprobaste esta, pero no celebres‚Ä¶ a√∫n falta que sepas usarlo en la vida real.",
            "¬°Incre√≠ble! Sabes lo b√°sico. ¬øAhora vas a aprender lo avanzado o te quedas ah√≠?",
            "Si fueras un anticonceptivo, ser√≠as el cond√≥n: a veces funciona, pero no siempre.",
            "¬°Bien hecho! Aunque si te emocionas por esto, no quiero ver tu cara cuando pases un examen de verdad.",
            "Correcto‚Ä¶ pero no te conf√≠es, que hasta un reloj roto da la hora bien dos veces al d√≠a.",
            "¬°Por fin! Ya solo te faltan otras 1,000 respuestas correctas para ser medianamente decente.",
            "Aprobado‚Ä¶ esta vez. La pr√≥xima, sin copiarle al de al lado, ¬øok?"
        ];

        const allQuestions = [
            { question: "¬øCu√°l de los siguientes m√©todos anticonceptivos tambi√©n protege contra infecciones de transmisi√≥n sexual (ITS)?", options: ["DIU", "P√≠ldora anticonceptiva", "Implante subd√©rmico", "Cond√≥n"], correct: 3 },
            { question: "¬øQu√© m√©todo anticonceptivo hormonal se toma diariamente?", options: ["Inyecci√≥n mensual", "P√≠ldora anticonceptiva", "Parche anticonceptivo", "DIU hormonal"], correct: 1 },
            { question: "¬øCu√°l de los siguientes m√©todos es un anticonceptivo de emergencia?", options: ["Parche", "P√≠ldora del d√≠a despu√©s", "Cond√≥n", "Espermicida"], correct: 1 },
            { question: "¬øD√≥nde se coloca el implante subd√©rmico?", options: ["Abdomen", "Pierna", "Brazo", "Espalda baja"], correct: 2 },
            { question: "¬øQu√© m√©todo anticonceptivo requiere una intervenci√≥n quir√∫rgica en el hombre?", options: ["DIU", "Vasectom√≠a", "Coitus interruptus", "Cond√≥n"], correct: 1 },
            { question: "¬øCu√°l es el principal mecanismo de acci√≥n de la p√≠ldora anticonceptiva combinada?", options: ["Destruir espermatozoides", "Inhibir la ovulaci√≥n", "Aumentar la menstruaci√≥n", "Cambiar la flora vaginal"], correct: 1 },
            { question: "¬øQu√© m√©todo se aplica semanalmente y se pega a la piel?", options: ["DIU", "Cond√≥n femenino", "Parche anticonceptivo", "Implante subd√©rmico"], correct: 2 },
            { question: "¬øCu√°l de los siguientes es un m√©todo de barrera?", options: ["P√≠ldora", "DIU", "Parche", "Cond√≥n femenino"], correct: 3 },
            { question: "¬øQu√© m√©todo anticonceptivo se coloca en el √∫tero?", options: ["Implante", "DIU", "P√≠ldora", "Parche"], correct: 1 },
            { question: "¬øCu√°l es un efecto secundario com√∫n de los m√©todos hormonales?", options: ["Visi√≥n mejorada", "Dolor de est√≥mago severo", "N√°useas", "Mayor energ√≠a"], correct: 2 },
            { question: "¬øQu√© m√©todo anticonceptivo puede durar hasta 5 a√±os?", options: ["P√≠ldora", "Parche", "DIU hormonal", "Espermicida"], correct: 2 },
            { question: "¬øQu√© m√©todo puede ser reversible y efectivo por varios a√±os sin mantenimiento diario?", options: ["Vasectom√≠a", "P√≠ldora", "DIU", "Cond√≥n"], correct: 2 },
            { question: "¬øCu√°l es el m√©todo m√°s adecuado si se desea protecci√≥n contra ITS y embarazo?", options: ["P√≠ldora + Parche", "DIU hormonal", "Cond√≥n", "Implante"], correct: 2 },
            { question: "¬øCu√°l es un m√©todo natural de planificaci√≥n familiar?", options: ["M√©todo del ritmo", "Parche", "DIU", "P√≠ldora"], correct: 0 },
            { question: "¬øQu√© m√©todo anticonceptivo se debe utilizar justo antes de la relaci√≥n sexual?", options: ["P√≠ldora", "Implante", "Espermicida", "DIU"], correct: 2 },
            { question: "¬øCu√°l de los siguientes NO es un m√©todo hormonal?", options: ["Parche", "DIU de cobre", "Implante", "Inyecci√≥n"], correct: 1 },
            { question: "¬øQu√© m√©todo anticonceptivo se administra una vez cada tres meses?", options: ["Parche", "DIU", "Inyecci√≥n anticonceptiva", "Cond√≥n"], correct: 2 },
            { question: "¬øQu√© m√©todo anticonceptivo puede afectar el ciclo menstrual?", options: ["P√≠ldora anticonceptiva", "Cond√≥n", "Espermicida", "DIU de cobre"], correct: 0 },
            { question: "¬øQu√© m√©todo se puede insertar hasta 5 d√≠as despu√©s de una relaci√≥n sin protecci√≥n como emergencia?", options: ["DIU de cobre", "Cond√≥n femenino", "Implante", "P√≠ldora combinada"], correct: 0 },
            { question: "¬øCu√°l es un m√©todo anticonceptivo quir√∫rgico para mujeres?", options: ["P√≠ldora", "Ligadura de trompas", "Parche", "DIU"], correct: 1 },
            { question: "¬øQu√© m√©todo puede causar cambios de humor como efecto secundario?", options: ["Cond√≥n", "Espermicida", "M√©todos hormonales", "Retiro"], correct: 2 },
            { question: "¬øCu√°l es la efectividad t√≠pica del cond√≥n masculino con uso correcto y consistente?", options: ["75%", "85%", "98%", "100%"], correct: 2 },
            { question: "El DIU de cobre, ¬øcontiene hormonas?", options: ["S√≠, progestina", "S√≠, estr√≥geno", "No, ninguna hormona", "S√≠, ambas"], correct: 2 },
            { question: "¬øLa p√≠ldora anticonceptiva protege contra el VIH?", options: ["S√≠, totalmente", "S√≠, parcialmente", "No, no protege", "Solo si se toman dos"], correct: 2 },
            { question: "¬øEs necesario un descanso de la p√≠ldora anticonceptiva despu√©s de varios a√±os de uso?", options: ["S√≠, cada 2 a√±os", "S√≠, cada 5 a√±os", "No, no es m√©dicamente necesario", "Solo si el m√©dico lo indica para otros problemas"], correct: 2 },
            { question: "¬øQu√© significa 'LARC' en anticoncepci√≥n?", options: ["M√©todo de acci√≥n r√°pida y corta", "Anticonceptivo reversible de acci√≥n larga", "Lubricante anticonceptivo de respuesta correcta", "L√°tex anticonceptivo resistente y confiable"], correct: 1 },
            { question: "El anillo vaginal se cambia cada...", options: ["D√≠a", "Semana", "Mes", "A√±o"], correct: 2 },
            { question: "¬øLos espermicidas son m√°s efectivos cuando se usan solos o con otro m√©todo de barrera?", options: ["Solos son suficientes", "Con otro m√©todo de barrera", "Da igual", "No se deben combinar"], correct: 1 },
            { question: "¬øLa vasectom√≠a es reversible?", options: ["Nunca", "Siempre y f√°cilmente", "A veces, pero es complejo y no garantizado", "Solo en los primeros 6 meses"], correct: 2 },
            { question: "Si olvidas tomar una p√≠ldora anticonceptiva combinada, ¬øqu√© deber√≠as hacer generalmente (consulta el prospecto espec√≠fico)?", options: ["No tomarla y esperar al d√≠a siguiente", "Tomar dos al d√≠a siguiente", "Tomarla tan pronto te acuerdes y seguir normal, usar m√©todo de respaldo si es necesario", "Dejar el paquete y empezar uno nuevo"], correct: 2 },
            { question: "¬øCu√°l de las siguientes afirmaciones sobre el M√©todo de Lactancia y Amenorrea (MELA/LAM) es incorrecta?", options: ["Requiere que el beb√© sea alimentado exclusivamente con leche materna.", "La madre debe amamantar con una frecuencia m√≠nima, incluso de noche.", "Solo es efectivo si la mujer a√∫n no ha tenido su primera menstruaci√≥n postparto.", "Su efectividad se mantiene alta despu√©s de los 6 meses del parto."], correct: 3 },
            { question: "¬øQu√© caracter√≠stica no poseen los m√©todos anticonceptivos naturales?", options: ["Ausencia de efectos secundarios hormonales.", "Costo elevado.", "Protecci√≥n contra Infecciones de Transmisi√≥n Sexual (ITS).", "Necesidad de procedimientos quir√∫rgicos."], correct: 2 },
            { question: "Identifica cu√°l de los siguientes es un m√©todo anticonceptivo de barrera:", options: ["La p√≠ldora combinada.", "El DIU hormonal.", "El diafragma.", "La ligadura de trompas."], correct: 2 },
            { question: "¬øCu√°l es el mecanismo de acci√≥n principal de los m√©todos anticonceptivos hormonales?", options: ["Crean una barrera f√≠sica para los espermatozoides.", "Inhiben la ovulaci√≥n y alteran el moco cervical y el endometrio.", "Destruyen los espermatozoides mediante qu√≠micos.", "Se basan en el c√°lculo de los d√≠as f√©rtiles."], correct: 1 },
            { question: "¬øCu√°l es el plazo m√°ximo para usar la p√≠ldora de anticoncepci√≥n de emergencia despu√©s de una relaci√≥n sexual sin protecci√≥n?", options: ["Hasta 2 d√≠as.", "Hasta 3 d√≠as.", "Hasta 5 d√≠as.", "Hasta 7 d√≠as."], correct: 2 },
            { question: "Seg√∫n las estad√≠sticas, ¬øcu√°l es uno de los m√©todos anticonceptivos m√°s prevalentes en Paraguay?", options: ["El diafragma.", "El m√©todo del ritmo.", "Los anticonceptivos orales.", "El DIU de cobre."], correct: 2 },
            { question: "¬øQu√© porcentaje de mujeres en edad reproductiva (15 a 49 a√±os) casadas o en uni√≥n en Paraguay utiliza alg√∫n m√©todo anticonceptivo moderno?", options: ["38%", "50.5%", "66.5%", "86%"], correct: 2 },
            { question: "¬øCu√°l de las siguientes condiciones no es una contraindicaci√≥n para el uso de m√©todos anticonceptivos que contienen estr√≥genos?", options: ["Migra√±a con aura.", "Hipertensi√≥n arterial controlada.", "Antecedentes personales de trombosis venosa profunda.", "Tabaquismo en mujeres mayores de 35 a√±os."], correct: 1 },
            { question: "Adem√°s de prevenir el embarazo, ¬øcu√°l es el beneficio m√°s importante del preservativo masculino?", options: ["Regula el ciclo menstrual.", "No tiene costo.", "Protege contra las Infecciones de Transmisi√≥n Sexual (ITS).", "Aumenta la sensibilidad durante el coito."], correct: 2 },
            { question: "¬øQu√© se necesita para usar el diafragma de manera efectiva?", options: ["Tomarlo diariamente a la misma hora.", "Una inyecci√≥n trimestral.", "Una valoraci√≥n m√©dica inicial para determinar la medida.", "Observaci√≥n diaria del moco cervical."], correct: 2 },
            { question: "¬øCu√°l es la sustancia activa m√°s com√∫n en los espermicidas?", options: ["Estr√≥geno.", "Progestina.", "Nonoxinol-9 (N-9).", "Cobre."], correct: 2 },
            { question: "¬øCu√°l es la tasa de falla de la ligadura de trompas (embarazos por 100 mujeres al a√±o)?", options: ["5-10.", "2-5.", "Menos de 1 (0.5 a 0.7).", "M√°s de 10."], correct: 2 },
            { question: "¬øQu√© procedimiento quir√∫rgico se realiza en una vasectom√≠a?", options: ["Se cortan y sellan las trompas de Falopio.", "Se inserta un dispositivo en el √∫tero.", "Se cortan y sellan los conductos deferentes.", "Se administra una inyecci√≥n hormonal mensual."], correct: 2 },
            { question: "¬øPara qu√© grupo de mujeres es especialmente adecuada la minip√≠ldora?", options: ["Mujeres que buscan una regulaci√≥n intensa de su ciclo menstrual.", "Mujeres lactantes.", "Mujeres con alergia al l√°tex.", "Hombres como m√©todo anticonceptivo."], correct: 1 },
            { question: "¬øCon qu√© frecuencia se debe aplicar el parche d√©rmico combinado?", options: ["Diariamente.", "Un parche por semana durante tres semanas, con una semana de descanso.", "Una vez al mes.", "Cada tres meses."], correct: 1 },
            { question: "¬øCu√°l es la duraci√≥n aproximada de efectividad de un implante subd√©rmico liberador de progestina?", options: ["Hasta 6 meses.", "Hasta 1 a√±o.", "Hasta 3-5 a√±os.", "Hasta 10 a√±os."], correct: 2 },
            { question: "Adem√°s de su alta eficacia, ¬øcu√°l es otra ventaja de los m√©todos anticonceptivos hormonales?", options: ["Ofrecen protecci√≥n contra todas las ITS.", "No requieren ning√∫n tipo de seguimiento m√©dico.", "Pueden reducir los s√≠ntomas menstruales y el riesgo de ciertos c√°nceres ginecol√≥gicos.", "Son completamente libres de efectos secundarios."], correct: 2 },
            { question: "¬øEn cu√°l de estas situaciones no se recomienda el uso de m√©todos anticonceptivos con estr√≥genos?", options: ["Mujeres con acn√© leve.", "Mujeres menores de 35 a√±os que no fuman.", "Mujeres con c√°ncer de mama actual o antecedentes.", "Mujeres que desean un m√©todo anticonceptivo reversible."], correct: 2 },
            { question: "Si una mujer no puede usar estr√≥genos, ¬øqu√© m√©todo anticonceptivo hormonal es una alternativa adecuada?", options: ["P√≠ldora combinada.", "Parche d√©rmico combinado.", "Anillo vaginal combinado.", "Implante subd√©rmico (solo progestina)."], correct: 3 },
            { question: "¬øCu√°l es la finalidad principal de la anticoncepci√≥n de emergencia?", options: ["Servir como un m√©todo de planificaci√≥n familiar de rutina.", "Prevenir el embarazo despu√©s de una relaci√≥n sexual sin protecci√≥n.", "Proteger contra las ITS de forma regular.", "Inducir la menstruaci√≥n."], correct: 1 },
            { question: "¬øQu√© m√©todo anticonceptivo ha mostrado un aumento significativo en su uso entre las adolescentes en Paraguay?", options: ["El m√©todo del calendario.", "El diafragma.", "Los implantes subd√©rmicos.", "La vasectom√≠a."], correct: 2 },
            { question: "¬øQu√© factor representa una barrera importante para el acceso a m√©todos anticonceptivos en Paraguay, especialmente en zonas rurales y para adolescentes?", options: ["Exceso de informaci√≥n y opciones disponibles.", "Bajo costo de todos los m√©todos.", "Distancia a los centros de salud y falta de recursos econ√≥micos.", "La obligatoriedad de uso impuesta por el gobierno."], correct: 2 },
            { question: "¬øCu√°l es la tasa de fallo t√≠pica (uso habitual) del m√©todo del ritmo o calendario?", options: ["Aproximadamente 10%.", "Entre 20% y 30%.", "Menos del 2%.", "Entre 1% y 5%."], correct: 1 },
            { question: "En el m√©todo de la Temperatura Basal Corporal, ¬øqu√© cambio fisiol√≥gico indica que la ovulaci√≥n ha ocurrido?", options: ["Un descenso brusco de la temperatura.", "Un ligero aumento sostenido de la temperatura (0.2 ¬∞C a 0.5 ¬∞C).", "La aparici√≥n de moco cervical el√°stico y transparente.", "El acortamiento del ciclo menstrual."], correct: 1 },
            { question: "¬øCu√°l es una condici√≥n para el uso correcto del preservativo masculino?", options: ["Usar vaselina como lubricante si es necesario.", "Colocarlo con el pene semi-erecto.", "Desenrrollarlo solo parcialmente.", "Guardarlos en un sitio fresco y usar condones de buena calidad."], correct: 3 },
            { question: "¬øPara qu√© tipo de mujeres es uno de los m√©todos de elecci√≥n el diafragma?", options: ["Mujeres que desean un m√©todo permanente.", "Mujeres con contraindicaci√≥n o intolerancia a la anticoncepci√≥n hormonal.", "Mujeres que prefieren no tener seguimiento m√©dico.", "Mujeres que buscan la m√°xima efectividad anticonceptiva posible."], correct: 1 },
            { question: "¬øCu√°l es la tasa de fallo t√≠pica (uso habitual) del m√©todo de Billings (moco cervical)?", options: ["Menos del 1%.", "Aproximadamente 2-5%.", "Aproximadamente 20%.", "M√°s del 30%."], correct: 2 },
            { question: "¬øQu√© porcentaje de adolescentes sexualmente activos en Paraguay no usaban m√©todos anticonceptivos hasta 2019?", options: ["20%", "40%", "66.5%", "86%"], correct: 3 }
        ];

        let currentQuestions = [];
        let gameMode = 'individual';
        let player1Name = "Jugador 1";
        let player2Name = "Jugador 2";
        let scores = { player1: 0, player2: 0 };
        let lives = { player1: GAME_CONFIG.MAX_LIVES, player2: GAME_CONFIG.MAX_LIVES };
        let playerTimes = { player1: GAME_CONFIG.DEFAULT_TIME, player2: GAME_CONFIG.DEFAULT_TIME };
        let currentPlayer = 1; 
        let currentQuestionIndex = 0;
        let totalQuestionsToPlay = 0;
        
        let questionTimerInterval;
        let questionTimeLeft = GAME_CONFIG.DEFAULT_TIME;

        let turnSelectionCountdownInterval;
        let turnSelectionTimeLeft = GAME_CONFIG.TURN_SELECT_COUNTDOWN;
        let keyRaceTimeout;
        let keyRaceActive = false;
        let gameEnded = false;
        let player1Eliminated = false;
        let player2Eliminated = false;
        let tieBreakerActive = false;


        // DOM Elements
        const menuScreen = document.getElementById('menuScreen');
        const setupScreen = document.getElementById('setupScreen');
        const gameScreen = document.getElementById('gameScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const player1NameInput = document.getElementById('player1NameInput');
        const player2NameInput = document.getElementById('player2NameInput');
        const versusInputsContainer = document.getElementById('versusInputsContainer');
        const questionCountSelect = document.getElementById('questionCountSelect');
        const playerInfoPanel = document.getElementById('playerInfoPanel');
        const currentTurnIndicator = document.getElementById('currentTurnIndicator');
        const progressFill = document.getElementById('progressFill');
        const questionTimerDisplay = document.getElementById('questionTimerDisplay');
        const questionProgressDisplay = document.getElementById('questionProgressDisplay');
        const questionNumberDisplay = document.getElementById('questionNumberDisplay');
        const questionTextDisplay = document.getElementById('questionTextDisplay');
        const optionsContainer = document.getElementById('optionsContainer');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const winnerText = document.getElementById('winnerText');
        const finalScoresText = document.getElementById('finalScoresText');
        const phraseOverlay = document.getElementById('phraseOverlay');
        const phraseText = document.getElementById('phraseText');
        const phrasePlayerName = document.getElementById('phrasePlayerName');
        const phraseLivesHeartsContainer = document.getElementById('phraseLivesHeartsContainer');
        const phraseCloseBtn = document.getElementById('phraseCloseBtn');
        const turnSelectorOverlay = document.getElementById('turnSelectorOverlay');
        const turnSelectorTitle = document.getElementById('turnSelectorTitle');
        const turnSelectionCountdownDisplay = document.getElementById('turnSelectionCountdownDisplay');
        const turnSelectorInstructionText = document.getElementById('turnSelectorInstructionText');
        const player1NameKeyRace = document.getElementById('player1NameKeyRace');
        const player2NameKeyRace = document.getElementById('player2NameKeyRace');

        // TieBreaker DOM Elements
        const tieBreakerOverlay = document.getElementById('tieBreakerOverlay');
        const tieBreakerTitle = document.getElementById('tieBreakerTitle'); // Assuming it's unique or shared style
        const tieBreakerCountdownDisplay = document.getElementById('tieBreakerCountdownDisplay');
        const tieBreakerTurnSelectorInstructionText = document.getElementById('tieBreakerTurnSelectorInstructionText');
        const player1NameKeyRaceTiebreaker = document.getElementById('player1NameKeyRaceTiebreaker');
        const player2NameKeyRaceTiebreaker = document.getElementById('player2NameKeyRaceTiebreaker');


        function switchScreen(screenToShow) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenToShow.classList.add('active');
        }

        function showSetup(mode) {
            gameMode = mode;
            switchScreen(setupScreen);
            player1NameInput.value = '';
            if (mode === 'versus') {
                versusInputsContainer.style.display = 'block';
                player2NameInput.value = '';
            } else {
                versusInputsContainer.style.display = 'none';
            }
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initiateGame() {
            player1Name = player1NameInput.value.trim() || "Jugador 1";
            if (gameMode === 'versus') {
                player2Name = player2NameInput.value.trim() || "Jugador 2";
                if (player1Name === player2Name) {
                    alert("Los nombres de los jugadores deben ser diferentes.");
                    return;
                }
            } else {
                player2Name = "Computadora"; 
            }

            const selectedQuestionCount = questionCountSelect.value;
            if (selectedQuestionCount === 'all' || gameMode === 'individual') {
                totalQuestionsToPlay = allQuestions.length;
            } else {
                totalQuestionsToPlay = parseInt(selectedQuestionCount);
            }
            currentQuestions = shuffleArray([...allQuestions]).slice(0, totalQuestionsToPlay);
            
            scores = { player1: 0, player2: 0 };
            lives = { player1: GAME_CONFIG.MAX_LIVES, player2: GAME_CONFIG.MAX_LIVES };
            playerTimes = { player1: GAME_CONFIG.DEFAULT_TIME, player2: GAME_CONFIG.DEFAULT_TIME }; 
            currentQuestionIndex = 0;
            gameEnded = false;
            player1Eliminated = false;
            player2Eliminated = false;
            tieBreakerActive = false; // Reset tie-breaker state
            keyRaceActive = false;
            
            clearInterval(questionTimerInterval);
            clearInterval(turnSelectionCountdownInterval);
            clearTimeout(keyRaceTimeout);
            removeKeyRaceListener();

            updatePlayerInfoDisplay();
            switchScreen(gameScreen);
            nextQuestionBtn.style.display = 'none';
            nextQuestionBtn.textContent = "‚û°Ô∏è Siguiente";


            if (gameMode === 'versus') {
                player1NameKeyRace.textContent = player1Name;
                player2NameKeyRace.textContent = player2Name;
                showTimedTurnSelector();
            } else {
                currentPlayer = 1; 
                displayQuestion();
            }
        }

        function showTimedTurnSelector() {
            if (gameEnded || tieBreakerActive) return; // Don't show if game ended or in tiebreaker setup

            // This check is now more nuanced due to one player potentially being out.
            // The advanceGameLogic will handle turns if one player is eliminated.
            // This function is primarily for when both players are active.

            turnSelectorOverlay.classList.add('show');
            turnSelectionTimeLeft = GAME_CONFIG.TURN_SELECT_COUNTDOWN;
            turnSelectionCountdownDisplay.textContent = turnSelectionTimeLeft;
            turnSelectionCountdownDisplay.classList.remove('urgent');
            turnSelectorInstructionText.textContent = "¬°Prep√°rense!";

            clearInterval(turnSelectionCountdownInterval); 
            turnSelectionCountdownInterval = setInterval(() => {
                turnSelectionTimeLeft--;
                turnSelectionCountdownDisplay.textContent = turnSelectionTimeLeft;
                if (turnSelectionTimeLeft <= 0) {
                    clearInterval(turnSelectionCountdownInterval);
                    turnSelectionCountdownDisplay.textContent = "¬°YA!";
                    turnSelectionCountdownDisplay.classList.add('urgent');
                    turnSelectorInstructionText.textContent = "¬°El primero en presionar su tecla gana el turno!";
                    startKeyRace();
                }
            }, 1000);
        }

        function startKeyRace() {
            keyRaceActive = true;
            addKeyRaceListener();

            clearTimeout(keyRaceTimeout); 
            keyRaceTimeout = setTimeout(() => {
                if (keyRaceActive) { 
                    keyRaceActive = false;
                    removeKeyRaceListener();
                    if (tieBreakerActive) {
                        tieBreakerOverlay.classList.remove('show');
                        showPhraseQuick("Nadie presion√≥ para el desempate... ¬°Se repetir√° la selecci√≥n de turno!", () => initiateTieBreaker());
                    } else {
                        turnSelectorOverlay.classList.remove('show');
                        showPhraseQuick("Nadie presion√≥... ¬°De nuevo!", showTimedTurnSelector);
                    }
                }
            }, GAME_CONFIG.KEY_RACE_TIME * 1000);
        }
        
        function handleTurnKeyPress(event) {
            if (!keyRaceActive) return;

            let turnWinner = null;
            if (event.code === 'Space' && (tieBreakerActive || !player1Eliminated)) { // Allow P1 if in tiebreaker or not eliminated
                turnWinner = 1;
            } else if (event.code === 'Enter' && (tieBreakerActive || !player2Eliminated )) { // Allow P2 if in tiebreaker or not eliminated
                turnWinner = 2;
            }


            if (turnWinner) {
                event.preventDefault(); 
                keyRaceActive = false;
                clearTimeout(keyRaceTimeout);
                removeKeyRaceListener();
                
                currentPlayer = turnWinner;
                const winnerName = currentPlayer === 1 ? player1Name : player2Name;
                
                if (tieBreakerActive) {
                    tieBreakerOverlay.classList.remove('show');
                    displayQuestion(); // Display the single tie-breaker question
                } else {
                    turnSelectorOverlay.classList.remove('show');
                    showPhraseQuick(`¬°Turno para ${winnerName}!`, displayQuestion);
                }
            }
        }

        function addKeyRaceListener() {
            document.addEventListener('keydown', handleTurnKeyPress);
        }
        function removeKeyRaceListener() {
            document.removeEventListener('keydown', handleTurnKeyPress);
        }
        
        function showPhraseQuick(message, callbackOnClose) {
            phraseText.innerHTML = message; 
            phrasePlayerName.textContent = ""; 
            phraseLivesHeartsContainer.innerHTML = ''; 
            phraseCloseBtn.style.display = 'none'; 
            phraseOverlay.classList.add('show');

            setTimeout(() => {
                phraseOverlay.classList.remove('show');
                if (callbackOnClose) callbackOnClose();
            }, 2200); // Slightly longer for important messages
        }


        function displayQuestion() {
            if (gameEnded && !tieBreakerActive) { // If game truly ended, don't display new Q
                 return;
            }
             if (!tieBreakerActive && currentQuestionIndex >= currentQuestions.length) {
                endGame(); // Should be caught by advanceGameLogic but as a safeguard
                return;
            }
            // For tie-breaker, currentQuestions is set to the single tie-breaker question.
            const q = tieBreakerActive ? currentQuestions[0] : currentQuestions[currentQuestionIndex];

            questionTextDisplay.textContent = q.question;
            if (tieBreakerActive) {
                questionNumberDisplay.textContent = `¬°PREGUNTA DE DESEMPATE!`;
                questionProgressDisplay.textContent = `¬°Todo o Nada!`;
            } else {
                questionNumberDisplay.textContent = `Pregunta ${currentQuestionIndex + 1}`;
                questionProgressDisplay.textContent = `Pregunta ${currentQuestionIndex + 1} de ${totalQuestionsToPlay}`;
            }
            
            optionsContainer.innerHTML = '';
            q.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.classList.add('option');
                button.textContent = option;
                button.onclick = () => selectAnswer(index, button);
                optionsContainer.appendChild(button);
            });

            updatePlayerInfoDisplay(); 
            if (!tieBreakerActive) updateProgressBar();
            startQuestionTimer(); 
            nextQuestionBtn.style.display = 'none';
            
            const currentPlayerName = (gameMode === 'individual' || currentPlayer === 1) ? player1Name : player2Name;
            if (tieBreakerActive) {
                currentTurnIndicator.textContent = `Responde ${currentPlayerName} para el desempate!`;
            } else {
                currentTurnIndicator.textContent = `Turno de: ${currentPlayerName}`;
                if (gameMode === 'individual') {
                    currentTurnIndicator.textContent = `Responde, ${player1Name}!`;
                }
            }
        }

        function startQuestionTimer() {
            if (gameMode === 'versus' && !tieBreakerActive) { // Timer reduction only in normal versus
                questionTimeLeft = (currentPlayer === 1) ? playerTimes.player1 : playerTimes.player2;
            } else { // Individual or Tie-breaker
                questionTimeLeft = GAME_CONFIG.DEFAULT_TIME; 
            }

            questionTimerDisplay.textContent = `‚è∞ ${questionTimeLeft}`;
            questionTimerDisplay.classList.remove('urgent');
            
            clearInterval(questionTimerInterval);
            questionTimerInterval = setInterval(() => {
                questionTimeLeft--;
                questionTimerDisplay.textContent = `‚è∞ ${questionTimeLeft}`;
                if (questionTimeLeft <= 10) {
                    questionTimerDisplay.classList.add('urgent');
                }
                if (questionTimeLeft <= 0) {
                    clearInterval(questionTimerInterval);
                    handleTimeOut();
                }
            }, 1000);
        }
        
        function renderPhraseHearts(currentLives, maxLives) {
            phraseLivesHeartsContainer.innerHTML = ''; 
            if (currentLives < 0) currentLives = 0;

            for (let i = 0; i < maxLives; i++) {
                const heartSpan = document.createElement('span');
                heartSpan.classList.add('life-heart-overlay');
                if (i < currentLives) {
                    heartSpan.innerHTML = '‚ù§Ô∏è'; 
                    heartSpan.style.color = '#ff4d4d'; 
                } else {
                    heartSpan.innerHTML = 'üñ§'; 
                    heartSpan.style.color = '#555';
                }
                phraseLivesHeartsContainer.appendChild(heartSpan);
            }
        }

        function handleTimeOut() {
            clearInterval(questionTimerInterval);
            optionsContainer.querySelectorAll('.option').forEach(opt => opt.classList.add('disabled'));

            if (tieBreakerActive) {
                gameEnded = true;
                const timedOutPlayerName = currentPlayer === 1 ? player1Name : player2Name;
                const winnerName = currentPlayer === 1 ? player2Name : player1Name; // Other player wins
                winnerText.innerHTML = `¬°${timedOutPlayerName} se qued√≥ sin tiempo en el desempate! ¬°${winnerName} GANA EL JUEGO! üèÜ`;
                finalScoresText.textContent = `Puntajes antes del desempate: ${player1Name} ${scores.player1} - ${player2Name} ${scores.player2}.`;
                switchScreen(resultsScreen);
                tieBreakerActive = false;
                hideAllOverlays();
                return;
            }

            const playerKey = (gameMode === 'individual' || currentPlayer === 1) ? 'player1' : 'player2';
            const playerNameForPhrase = (gameMode === 'individual' || currentPlayer === 1) ? player1Name : player2Name;
            let message = burlasBrutales[Math.floor(Math.random() * burlasBrutales.length)]; 
            
            const livesBeforeUpdate = lives[playerKey];
            let livesMessagePart = "";

            if (livesBeforeUpdate > 0) { // Only show message about losing a life if they had one
                const livesActuallyLeft = livesBeforeUpdate - 1;
                if (livesActuallyLeft > 0) {
                    livesMessagePart = ` <span class="lives-remaining-highlight">Te quedan ${livesActuallyLeft} ${livesActuallyLeft === 1 ? 'vida' : 'vidas'}.</span>`;
                } else { 
                    livesMessagePart = ` <span class="lives-remaining-highlight">¬°Has perdido todas tus vidas!</span>`;
                }
                renderPhraseHearts(livesActuallyLeft, GAME_CONFIG.MAX_LIVES);
            } else { // Already had 0 lives (shouldn't happen if player is eliminated, but as a fallback)
                 phraseLivesHeartsContainer.innerHTML = ''; 
            }
            
            showPhrase(`¬°Tiempo agotado! ‚åõÔ∏è ${message}${livesMessagePart}`, playerNameForPhrase, false);
            processAnswer(false); 
        }

        function selectAnswer(selectedIndex, optionElement) {
            clearInterval(questionTimerInterval);
            optionsContainer.querySelectorAll('.option').forEach(opt => opt.classList.add('disabled'));

            const question = tieBreakerActive ? currentQuestions[0] : currentQuestions[currentQuestionIndex];
            const correct = selectedIndex === question.correct;

            if (tieBreakerActive) {
                gameEnded = true; // Tie-breaker decides the game
                let winnerNum, loserNum;
                const answeringPlayerName = currentPlayer === 1 ? player1Name : player2Name;
                const otherPlayerName = currentPlayer === 1 ? player2Name : player1Name;

                if (correct) {
                    optionElement.classList.add('correct');
                    winnerText.innerHTML = `¬°${answeringPlayerName} acert√≥ en el desempate y GANA EL JUEGO! üèÜ`;
                } else {
                    optionElement.classList.add('incorrect');
                     if(optionsContainer.children[question.correct]) optionsContainer.children[question.correct].classList.add('correct');
                    winnerText.innerHTML = `¬°${answeringPlayerName} fall√≥ en el desempate! ¬°${otherPlayerName} GANA EL JUEGO! üèÜ`;
                }
                finalScoresText.textContent = `Puntajes antes del desempate: ${player1Name} ${scores.player1} - ${player2Name} ${scores.player2}.`;
                switchScreen(resultsScreen);
                tieBreakerActive = false; 
                hideAllOverlays();
                return;
            }

            const playerKey = (gameMode === 'individual' || currentPlayer === 1) ? 'player1' : 'player2';
            const playerNameForPhrase = (gameMode === 'individual' || currentPlayer === 1) ? player1Name : player2Name;

            optionElement.classList.add(correct ? 'correct' : 'incorrect');
            if (!correct) {
                if(optionsContainer.children[question.correct]) optionsContainer.children[question.correct].classList.add('correct');
            }
            
            let baseMessage;
            let livesMessagePart = "";
            let subMessage = `${playerNameForPhrase}`;

            if (correct) {
                baseMessage = elogiosSarcasmoBrutal[Math.floor(Math.random() * elogiosSarcasmoBrutal.length)];
                phraseLivesHeartsContainer.innerHTML = ''; 
            } else {
                baseMessage = burlasBrutales[Math.floor(Math.random() * burlasBrutales.length)];
                const livesBeforeUpdate = lives[playerKey];
                if (livesBeforeUpdate > 0) { // Only show message about losing life if they had one
                    const livesActuallyLeft = livesBeforeUpdate - 1; 
                    if (livesActuallyLeft > 0) {
                        livesMessagePart = ` <span class="lives-remaining-highlight">Te quedan ${livesActuallyLeft} ${livesActuallyLeft === 1 ? 'vida' : 'vidas'}.</span>`;
                    } else { 
                        livesMessagePart = ` <span class="lives-remaining-highlight">¬°Has perdido todas tus vidas!</span>`;
                    }
                    renderPhraseHearts(livesActuallyLeft, GAME_CONFIG.MAX_LIVES);
                } else {
                    phraseLivesHeartsContainer.innerHTML = ''; 
                }
            }
            showPhrase(`${baseMessage}${livesMessagePart}`, subMessage, correct); 
            processAnswer(correct);
        }
        
        function processAnswer(isCorrect) {
            if (tieBreakerActive || gameEnded) return; // Already handled or game is over

            const playerKey = (gameMode === 'individual' || currentPlayer === 1) ? 'player1' : 'player2';
            
            if (isCorrect) {
                scores[playerKey] += 10;
                if (gameMode === 'versus') {
                    playerTimes[playerKey] = Math.max(GAME_CONFIG.MIN_TIME, playerTimes[playerKey] - GAME_CONFIG.TIME_REDUCTION_ON_CORRECT);
                }
            } else {
                if (lives[playerKey] > 0) { 
                    lives[playerKey]--; 
                    if (lives[playerKey] <= 0) {
                        lives[playerKey] = 0; 
                        if (playerKey === 'player1') player1Eliminated = true;
                        if (playerKey === 'player2') player2Eliminated = true;
                    }
                }
            }
            updatePlayerInfoDisplay();
            nextQuestionBtn.style.display = 'block'; 
             nextQuestionBtn.textContent = (gameMode === 'versus' && (player1Eliminated || player2Eliminated) && !(player1Eliminated && player2Eliminated)) || (currentQuestionIndex + 1 >= totalQuestionsToPlay) ? "üèÅ Ver Resultados/Continuar" : "‚û°Ô∏è Siguiente Pregunta";
        }

        function proceedToNextStep() { 
            closePhraseOverlay(); 
            advanceGameLogic();
        }

        function advanceGameLogic() {
            if (gameEnded || tieBreakerActive) return;

            currentQuestionIndex++;
            nextQuestionBtn.style.display = 'none';

            // Check for game end conditions BEFORE proceeding to next turn/question
            if (gameMode === 'versus') {
                if (player1Eliminated && player2Eliminated) { // Both are out
                    endGame(); 
                    return;
                }
                if (player1Eliminated && !player2Eliminated) { // P1 out, P2 active
                    if (scores.player2 > scores.player1) {
                        showPhraseQuick(`¬°${player2Name} super√≥ a ${player1Name} y GANA!`, () => endGameVersusWinner(2, 1));
                        return;
                    }
                    // P2 lost last life OR questions ran out, and P2 DID NOT surpass P1
                    if (lives.player2 <= 0 || currentQuestionIndex >= totalQuestionsToPlay) {
                        showPhraseQuick(`¬°${player2Name} no logr√≥ superar a ${player1Name}! ¬°${player1Name} GANA!`, () => endGameVersusWinner(1, 2, true));
                        return;
                    }
                } else if (!player1Eliminated && player2Eliminated) { // P2 out, P1 active
                    if (scores.player1 > scores.player2) {
                        showPhraseQuick(`¬°${player1Name} super√≥ a ${player2Name} y GANA!`, () => endGameVersusWinner(1, 2));
                        return;
                    }
                     // P1 lost last life OR questions ran out, and P1 DID NOT surpass P2
                    if (lives.player1 <= 0 || currentQuestionIndex >= totalQuestionsToPlay) {
                        showPhraseQuick(`¬°${player1Name} no logr√≥ superar a ${player2Name}! ¬°${player2Name} GANA!`, () => endGameVersusWinner(2, 1, true));
                        return;
                    }
                }
            } else { // Individual mode
                if (player1Eliminated || currentQuestionIndex >= totalQuestionsToPlay) {
                    endGame();
                    return;
                }
            }
            
            // If game hasn't ended based on above, check if all questions are done
            if (currentQuestionIndex >= totalQuestionsToPlay) {
                endGame(); // Handles final scores, ties for versus
                return;
            }

            // If game continues:
            if (gameMode === 'versus') {
                if (player1Eliminated) { // P1 out, P2 continues (and P2 still has lives and questions remain)
                    currentPlayer = 2;
                    showPhraseQuick(`¬°${player1Name} ha sido eliminado! ${player2Name}, ¬°debes superar los ${scores.player1} puntos de ${player1Name} para ganar!`, displayQuestion);
                } else if (player2Eliminated) { // P2 out, P1 continues
                    currentPlayer = 1;
                     showPhraseQuick(`¬°${player2Name} ha sido eliminado! ${player1Name}, ¬°debes superar los ${scores.player2} puntos de ${player2Name} para ganar!`, displayQuestion);
                } else { // Both in
                    showTimedTurnSelector();
                }
            } else { // Individual mode, game continues
                displayQuestion();
            }
        }


        function updatePlayerInfoDisplay() {
            playerInfoPanel.innerHTML = '';
            const playersToDisplay = gameMode === 'individual' ? [{name: player1Name, key: 'player1'}] 
                                                              : [{name: player1Name, key: 'player1'}, {name: player2Name, key: 'player2'}];
            
            playersToDisplay.forEach(playerObj => {
                const name = playerObj.name;
                const pKey = playerObj.key;

                const playerDiv = document.createElement('div');
                playerDiv.classList.add('player');
                
                // Active turn highlight, not during tiebreaker display as turn is specific
                if (!tieBreakerActive && !gameEnded) {
                    if ((gameMode === 'versus' && ((pKey === 'player1' && currentPlayer === 1) || (pKey === 'player2' && currentPlayer === 2))) ||
                        (gameMode === 'individual' && pKey === 'player1')) {
                         if (! ( (pKey === 'player1' && player1Eliminated) || (pKey === 'player2' && player2Eliminated) ) ) { // Don't highlight eliminated player
                            playerDiv.classList.add('active-turn');
                         }
                    }
                }


                const nameEl = document.createElement('div');
                nameEl.classList.add('player-name');
                nameEl.textContent = name;
                playerDiv.appendChild(nameEl);

                const scoreEl = document.createElement('div');
                scoreEl.classList.add('player-score');
                scoreEl.textContent = `Puntos: ${scores[pKey]}`;
                playerDiv.appendChild(scoreEl);

                if (gameMode === 'versus' || gameMode === 'individual') { // Show lives for both modes
                    const livesContainerEl = document.createElement('div');
                    livesContainerEl.classList.add('lives-container');
                    
                    const livesTextEl = document.createElement('span');
                    livesTextEl.classList.add('lives-text');
                    livesTextEl.textContent = "Vidas:";
                    livesContainerEl.appendChild(livesTextEl);

                    const heartsDiv = document.createElement('div');
                    heartsDiv.classList.add('life-hearts');
                    for (let i = 0; i < GAME_CONFIG.MAX_LIVES; i++) {
                        const lifeHeart = document.createElement('span');
                        lifeHeart.classList.add('life');
                        lifeHeart.innerHTML = '&#x2764;'; 
                        if (i >= lives[pKey]) {
                            lifeHeart.classList.add('lost');
                        }
                        heartsDiv.appendChild(lifeHeart);
                    }
                    livesContainerEl.appendChild(heartsDiv);
                    playerDiv.appendChild(livesContainerEl);

                    if ((pKey === 'player1' && player1Eliminated) || (pKey === 'player2' && player2Eliminated)) {
                        const eliminatedText = document.createElement('div');
                        eliminatedText.textContent = "ELIMINADO";
                        eliminatedText.style.color = "#ff4444";
                        eliminatedText.style.fontWeight = "bold";
                        eliminatedText.style.marginTop = "5px";
                        playerDiv.appendChild(eliminatedText);
                        playerDiv.style.opacity = 0.6;
                    }
                }
                playerInfoPanel.appendChild(playerDiv);
            });
        }
        
        function updateProgressBar() {
            const percentage = totalQuestionsToPlay > 0 ? (currentQuestionIndex / totalQuestionsToPlay) * 100 : 0;
            progressFill.style.width = `${percentage}%`;
        }
        
        function showPhrase(message, subMessage = "", isCorrect = null) {
            phraseText.innerHTML = message; 
            phrasePlayerName.textContent = subMessage; 
            phraseCloseBtn.style.display = 'block'; 

            if (isCorrect === true) {
                phraseText.style.color = '#4CAF50'; 
                phrasePlayerName.style.color = '#ffd700'; 
            } else if (isCorrect === false) {
                phraseText.style.color = '#f44336'; 
                phrasePlayerName.style.color = '#ffd700'; 
            } else { 
                phraseText.style.color = 'white'; 
                phrasePlayerName.style.color = '#ffd700';
            }
            
            if (isCorrect === true || isCorrect === null) {
                phraseLivesHeartsContainer.innerHTML = '';
            }
            phraseOverlay.classList.add('show');
        }


        function closePhraseOverlay() {
            phraseOverlay.classList.remove('show');
        }
        function hideAllOverlays() {
            phraseOverlay.classList.remove('show');
            turnSelectorOverlay.classList.remove('show');
            tieBreakerOverlay.classList.remove('show');
        }


        function endGameVersusWinner(winnerNum, loserNum, loserFailedToSurpass = false) {
            if (gameEnded) return;
            gameEnded = true;
            hideAllOverlays();
            const winnerName = winnerNum === 1 ? player1Name : player2Name;
            const loserName = loserNum === 1 ? player1Name : (loserNum === 2 ? player2Name : "Oponente");


            if (loserFailedToSurpass) {
                winnerText.innerHTML = `¬°${winnerName} es el/la ganador/a! ${loserName} fue eliminado/a y no logr√≥ superar el puntaje.`;
            } else {
                 winnerText.innerHTML = `¬°${winnerName} es el/la ganador/a! Super√≥ el puntaje de ${loserName}.`;
            }

            finalScoresText.textContent = `${player1Name}: ${scores.player1} pts | ${player2Name}: ${scores.player2} pts`;
            switchScreen(resultsScreen);
        }


        function endGame() {
            if (gameEnded && !tieBreakerActive) return; 
            // If tieBreakerActive is true, it means we are INITIATING it, not ending it from a tiebreaker question.
            // The end from a tiebreaker question is handled in selectAnswer/handleTimeOut.
            
            clearInterval(questionTimerInterval);
            clearInterval(turnSelectionCountdownInterval);
            clearTimeout(keyRaceTimeout);
            removeKeyRaceListener();
            keyRaceActive = false;
            hideAllOverlays();
            
            let winnerMessage = "";
            let finalScoresMsg = "";

            if (gameMode === 'individual') {
                gameEnded = true;
                if (lives.player1 > 0 && currentQuestionIndex >= totalQuestionsToPlay) { 
                    winnerMessage = `¬°Felicidades, ${player1Name}! ${frasesGanador[Math.floor(Math.random() * frasesGanador.length)]}`;
                } else if (lives.player1 <= 0) { 
                    winnerMessage = `¬°Oh no, ${player1Name}! Has perdido todas tus vidas. ${frasesPerdedor[Math.floor(Math.random() * frasesPerdedor.length)]}`;
                } else { // Finished questions but maybe not "won" in a traditional sense if lives were low
                     winnerMessage = `¬°Juego completado, ${player1Name}!`;
                }
                finalScoresMsg = `Puntaje final: ${scores.player1}`;
            } else { // Versus Mode - this is called when all questions are done, or both players fully eliminated.
                finalScoresMsg = `${player1Name}: ${scores.player1} pts | ${player2Name}: ${scores.player2} pts`;

                if (scores.player1 > scores.player2) {
                    winnerMessage = `¬°${player1Name} es el/la ganador/a con m√°s puntos!`;
                } else if (scores.player2 > scores.player1) {
                    winnerMessage = `¬°${player2Name} es el/la ganador/a con m√°s puntos!`;
                } else { // SCORES ARE TIED!
                    initiateTieBreaker();
                    return; // Don't proceed to show results yet, tiebreaker will handle it.
                }
                gameEnded = true; // Ensure game is marked ended here for versus if no tiebreaker
            }
            
            winnerText.innerHTML = winnerMessage; 
            finalScoresText.textContent = finalScoresMsg;
            switchScreen(resultsScreen);
        }

        function initiateTieBreaker() {
            if (gameEnded && tieBreakerActive) return; // Already in one or just finished.
            hideAllOverlays();
            
            tieBreakerActive = true;
            gameEnded = false; // Game is "active" for this one question

            let tempQuestions = shuffleArray([...allQuestions]);
            // Try to find a question not recently used if possible, or just a random one
            currentQuestions = tempQuestions.slice(0, 1); 

            if (currentQuestions.length === 0) {
                gameEnded = true; tieBreakerActive = false;
                winnerText.innerHTML = "¬°EMPATE T√âCNICO! No quedan preguntas para el desempate.";
                finalScoresText.textContent = `Puntajes originales: ${player1Name}: ${scores.player1} | ${player2Name}: ${scores.player2}.`;
                switchScreen(resultsScreen);
                return;
            }
            currentQuestionIndex = 0; 
            totalQuestionsToPlay = 1; 

            player1NameKeyRaceTiebreaker.textContent = player1Name;
            player2NameKeyRaceTiebreaker.textContent = player2Name;
            
            updatePlayerInfoDisplay(); // Show scores for context
            switchScreen(gameScreen); // Use main game screen for the question

            currentTurnIndicator.textContent = "¬°RONDA DE DESEMPATE!";
            progressFill.style.width = '0%';
            questionProgressDisplay.textContent = "Pregunta de Desempate: 1 de 1";
            nextQuestionBtn.style.display = 'none'; // No next button for tiebreaker

            tieBreakerOverlay.classList.add('show');
            turnSelectionTimeLeft = GAME_CONFIG.TURN_SELECT_COUNTDOWN;
            tieBreakerCountdownDisplay.textContent = turnSelectionTimeLeft;
            tieBreakerCountdownDisplay.classList.remove('urgent');
            tieBreakerTurnSelectorInstructionText.textContent = "¬°Prep√°rense para el desempate!";

            clearInterval(turnSelectionCountdownInterval);
            turnSelectionCountdownInterval = setInterval(() => {
                turnSelectionTimeLeft--;
                tieBreakerCountdownDisplay.textContent = turnSelectionTimeLeft;
                if (turnSelectionTimeLeft <= 0) {
                    clearInterval(turnSelectionCountdownInterval);
                    tieBreakerCountdownDisplay.textContent = "¬°YA!";
                    tieBreakerCountdownDisplay.classList.add('urgent');
                    tieBreakerTurnSelectorInstructionText.textContent = "¬°Presiona tu tecla!";
                    startKeyRace(); // keyRaceActive will be true. handleTurnKeyPress will manage.
                }
            }, 1000);
        }


        function resetGameAndShowMenu() {
            currentQuestions = [];
            gameMode = 'individual';
            scores = { player1: 0, player2: 0 };
            lives = { player1: GAME_CONFIG.MAX_LIVES, player2: GAME_CONFIG.MAX_LIVES };
            playerTimes = { player1: GAME_CONFIG.DEFAULT_TIME, player2: GAME_CONFIG.DEFAULT_TIME };
            currentPlayer = 1;
            currentQuestionIndex = 0;
            totalQuestionsToPlay = 0;
            
            gameEnded = false;
            player1Eliminated = false;
            player2Eliminated = false;
            tieBreakerActive = false;
            keyRaceActive = false;

            clearInterval(questionTimerInterval);
            clearInterval(turnSelectionCountdownInterval);
            clearTimeout(keyRaceTimeout);
            removeKeyRaceListener();
            
            playerInfoPanel.innerHTML = '';
            currentTurnIndicator.textContent = '';
            progressFill.style.width = '0%';
            questionTimerDisplay.textContent = `‚è∞ ${GAME_CONFIG.DEFAULT_TIME}`;
            questionTimerDisplay.classList.remove('urgent');
            optionsContainer.innerHTML = '';
            nextQuestionBtn.style.display = 'none';
            nextQuestionBtn.textContent = "‚û°Ô∏è Siguiente Pregunta";

            
            hideAllOverlays();
            phraseLivesHeartsContainer.innerHTML = '';


            switchScreen(menuScreen);
        }

        // Initial setup
        switchScreen(menuScreen);

    </script>
</body>
</html>
